version <- "1.8"
version_date <- lubridate::ymd("2020-02-28")
knitr::opts_chunk$set(echo = FALSE, cache=TRUE,
tidy.opts=list(width.cutoff=60),
tidy=TRUE)
library(tidyverse)
library(magrittr)
library(lubridate)
library(tibble)
library(ggplot2)
library(ggthemes)
library(hrbrthemes)
library(rvest)
library(gt)
library(deSolve)
library(EpiEstim)
library(incidence)
library(distcrete)
library(epitrix)
library(projections)
library(formatR)
# download the wikipedia web page
# we use a specific version of the template page directly
# version of the wikipedia page that is used by this version of this document
portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
# unversioned page
# portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
portuguese_outbreak_webpage <- read_html(portuguese_wikipedia_data_url)
# read tables
tbls <- html_nodes(portuguese_outbreak_webpage, "table")
head(tbls)
tbls_ls <- portuguese_outbreak_webpage %>%
html_nodes("table") %>%
.[5:6] %>%
html_table(fill = TRUE)
# verification of the parameters of the table
str(tbls_ls)
head (tbls_ls)
# remove row 1 that includes part of the headings
tbls_ls[[1]] <- tbls_ls[[1]][-2]
# remove row 1 that includes part of the headings
tbls_ls[[1]]<- tbls_ls[[2]][-1,]
tbls_ls[[1]]
#last_date_j <- ymd("2020-03-01")
# download the wikipedia web page
# we use a specific version of the template page directly
# version of the wikipedia page that is used by this version of this document
portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
# unversioned page
# portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
portuguese_outbreak_webpage <- read_html(portuguese_wikipedia_data_url)
# read tables
tbls <- html_nodes(portuguese_outbreak_webpage, "table")
#head(tbls)
tbls_ls <- portuguese_outbreak_webpage %>%
html_nodes("table") %>%
.[5:6] %>%
html_table(fill = TRUE)
# verification of the parameters of the table
#str(tbls_ls)
#head (tbls_ls)
# remove row 1 that includes part of the headings
tbls_ls[[1]] <- tbls_ls[[1]][-2]
# remove row 1 that includes part of the headings
tbls_ls[[1]]<- tbls_ls[[2]][-1,]
tbls_ls[[1]]
# rename table headings
colnames(tbls_ls[[1]]) <- c("Date", "Confirmed Cases")
#atribute values
Infected<-tbls_ls[[1]]$`Confirmed Cases`
#convert date in Char to date format
Date <-tbls_ls[[1]]$`Date`
Date<-seq(as.Date('2020-03-03'), as.Date('2020-12-31'), by = 'days')
#Date <- as_tibble(Date)
#Inseri os valores de Portugal até dia 17-04-2020:
Day <- 1:(length(Infected))
N <- 10000000 # população de Portugal
old <- par(mfrow = c(1, 2))
plot(Day, Infected, type ="b")
plot(Day, Infected, log = "y")
#abline(lm(log10(Infected) ~ Dia))
title("Cumulative confirmed cases 2020-Portugal", outer = TRUE, line = -2)
SIR <- function(time, state, parameters) {
par <- as.list(c(state, parameters))
with(par, {
dS <- -beta/N * I * S
dI <- beta/N * I * S - gamma * I
dR <- gamma * I
list(c(dS, dI, dR))
})
}
#select data until day 20-03-2020, exponecial growth rate
# download the wikipedia web page
# we use a specific version of the template page directly
# version of the wikipedia page that is used by this version of this document
portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
# unversioned page
# portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
portuguese_outbreak_webpage <- read_html(portuguese_wikipedia_data_url)
# read tables
tbls <- html_nodes(portuguese_outbreak_webpage, "table")
head(tbls)
tbls_ls <- portuguese_outbreak_webpage %>%
html_nodes("table") %>%
.[5:6] %>%
html_table(fill = TRUE)
# verification of the parameters of the table
str(tbls_ls)
head (tbls_ls)
#até aqui funciona!!
# remove row 1 that includes part of the headings
tbls_ls[[1]] <- tbls_ls[[1]][-2]
# remove row 1 that includes part of the headings
tbls_ls[[1]]<- tbls_ls[[2]][-1,]
tbls_ls[[1]]
# download the wikipedia web page
# we use a specific version of the template page directly
# version of the wikipedia page that is used by this version of this document
portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
# unversioned page
# portuguese_wikipedia_data_url <- "https://pt.wikipedia.org/wiki/Pandemia_de_COVID-19_em_Portugal#Evolu%C3%A7%C3%A3o_dos_casos"
portuguese_outbreak_webpage <- read_html(portuguese_wikipedia_data_url)
# read tables
tbls <- html_nodes(portuguese_outbreak_webpage, "table")
#head(tbls)
tbls_ls <- portuguese_outbreak_webpage %>%
html_nodes("table") %>%
.[5:6] %>%
html_table(fill = TRUE)
# verification of the parameters of the table
#str(tbls_ls)
#head (tbls_ls)
# remove row 1 that includes part of the headings
tbls_ls[[1]] <- tbls_ls[[1]][-2]
# remove row 1 that includes part of the headings
tbls_ls[[1]]<- tbls_ls[[2]][-1,]
# rename table headings
colnames(tbls_ls[[1]]) <- c("Date", "Confirmed Cases")
#atribute values
Infected<-tbls_ls[[1]]$`Confirmed Cases`
#convert date in Char to date format
Date <-tbls_ls[[1]]$`Date`
Date<-seq(as.Date('2020-03-03'), as.Date('2020-03-20'), by = 'days')
Infected<-Infected[1:18]
#tbls_ls[[1]]$`Date`<- Date
#select data until day 20-03-2020, exponecial growth rate
data.frame<-data.frame(Date,Infected)
Infected<-data.frame[data.frame$Infected <=1220, ]
Date<-data.frame$Date
Infected<-data.frame$Infected
#atribute values without intervention or social distancing
Infected_exp<-Infected
#Inseri os valores de Portugal até dia 20-03-2020:
Day <- 1:(length(Infected))
N <- 10000000 # população de Portugal
old <- par(mfrow = c(1, 2))
plot(Day, Infected, type ="b")
plot(Day, Infected, log = "y")
#abline(lm(log10(Infected) ~ Dia))
title("Cumulative confirmed cases 2020-Portugal", outer = TRUE, line = -2)
SIR <- function(time, state, parameters) {
par <- as.list(c(state, parameters))
with(par, {
dS <- -beta/N * I * S
dI <- beta/N * I * S - gamma * I
dR <- gamma * I
list(c(dS, dI, dR))
})
}
#library(deSolve)
init <- c(S = N-Infected_exp[1], I = Infected_exp[1], R = 0)
RSS <- function(parameters) {
names(parameters) <- c("beta", "gamma")
out <- ode(y = init, times = Day, func = SIR, parms = parameters)
fit <- out[ , 3]
sum((Infected_exp - fit)^2)
}
Opt <- optim(c(0.5, 0.5), RSS, method = "L-BFGS-B", lower = c(0, 0), upper = c(1, 1)) # optimize with some sensible conditions
Opt$message
#[1] "CONVERGENCE: REL_REDUCTION_OF_F <= FACTR*EPSMCH"
Opt_par <- setNames(Opt$par, c("beta", "gamma"))
Opt_par
#beta     gamma
## 0.6746089 0.3253912
t <- 1:100 # time in days
fit <- data.frame(ode(y = init, times = t, func = SIR, parms = Opt_par))
col <- 1:3 # colour
matplot(fit$time, fit[ , 2:4], type = "l", xlab = "Day", ylab = "Number of subjects", lwd = 2, lty = 1, col = col)
matplot(fit$time, fit[ , 2:4], type = "l", xlab = "Day", ylab = "Number of subjects", lwd = 2, lty = 1, col = col, log = "y")
## Warning in xy.coords(x, y, xlabel, ylabel, log = log): 1 y value <= 0
## omitted from logarithmic plot
points(Day, Infected_exp)
legend("bottomright", c("Susceptibles", "Infecteds", "Recovereds"), lty = 1, lwd = 2, col = col, inset = 0.05)
title("SIR model COVID19 Portugal", outer = TRUE, line = -2)
par(old)
R0 <- setNames(Opt_par["beta"] / Opt_par["gamma"], "R0")
R0
##       R0
## 1.98384
fit[fit$I == max(fit$I), "I", drop = FALSE] # height of pandemic
##            I
## 37 616443.4
max(fit$I) * 0.02 # max deaths with supposed 2% fatality rate
## [1] 12328.87
install.packages("distill")
